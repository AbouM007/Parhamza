(auto-crÃ©ation de lâ€™utilisateur dans public.users) se fait directement ici, dans authenticateUser.

Aujourdâ€™hui, ton code fait Ã§a :

if (userError || !dbUser) {
  return res.status(401).json({ error: 'Utilisateur non trouvÃ©' });
}


â¡ï¸ Du coup, si lâ€™utilisateur nâ€™existe pas encore dans public.users, tu prends un 401.

ğŸ”§ Ce quâ€™il faut modifier

Ã€ la place de renvoyer 401 direct, tu crÃ©es automatiquement la ligne dans users avec les infos de auth.users.

âœ… Version corrigÃ©e de authenticateUser

Tu peux remplacer ton bloc complet par celui-ci :

export const authenticateUser = async (req: Request, res: Response, next: NextFunction) => {
  try {
    const authHeader = req.headers.authorization;
    if (!authHeader || !authHeader.startsWith("Bearer ")) {
      return res.status(401).json({ error: "Token d'authentification manquant" });
    }

    const token = authHeader.substring(7);

    // VÃ©rifier le token auprÃ¨s de Supabase
    const { data: { user }, error } = await supabaseServer.auth.getUser(token);

    if (error || !user) {
      return res.status(401).json({ error: "Token invalide" });
    }

    // VÃ©rifier si l'utilisateur existe dÃ©jÃ  dans notre table users
    let { data: dbUser, error: userError } = await supabaseServer
      .from("users")
      .select("id, email, type, name")
      .eq("id", user.id)
      .single();

    // âœ… Auto-crÃ©er l'utilisateur s'il n'existe pas
    if (userError || !dbUser) {
      const { data: newUser, error: insertError } = await supabaseServer
        .from("users")
        .insert({
          id: user.id,
          email: user.email,
          name: user.user_metadata?.full_name || user.email,
          type: "individual", // par dÃ©faut
          profile_completed: false,
          created_at: new Date().toISOString(),
        })
        .select("id, email, type, name")
        .single();

      if (insertError) {
        console.error("âŒ Erreur crÃ©ation user:", insertError);
        return res.status(500).json({ error: "Impossible de crÃ©er l'utilisateur" });
      }

      dbUser = newUser;
    }

    // Attacher l'utilisateur Ã  la requÃªte
    req.user = {
      id: dbUser.id,
      email: dbUser.email,
      type: dbUser.type,
    };

    next();
  } catch (error) {
    console.error("âŒ Erreur authentification:", error);
    return res.status(500).json({ error: "Erreur serveur authentification" });
  }
};

ğŸš€ RÃ©sultat

Nouvel utilisateur : il est crÃ©Ã© automatiquement dans public.users dÃ¨s le premier appel API.

Utilisateur existant : rÃ©cupÃ©rÃ© normalement.

Plus de 401 Unauthorized bloquant lors du premier onboarding.