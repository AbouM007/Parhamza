je te fais un rÃ©sumÃ© clair de ce quâ€™on a fait aujourdâ€™hui :

ğŸ“Œ RÃ©sumÃ© de la journÃ©e
1. Quota des annonces

Tu avais une ancienne fonction checkProfessionalListingQuota â†’ qui ne limitait pas les particuliers.

On lâ€™a remplacÃ©e par checkListingQuota pour gÃ©rer Ã  la fois :

Particuliers gratuits (quota = 5 annonces, en dur),

Pros avec abonnement (quota depuis subscription_plans.max_listings dans la DB),

Pros illimitÃ©s (max_listings = null).

On a confirmÃ© que le quota est bien vÃ©rifiÃ© dans POST /api/vehicles avant insertion.

2. ProblÃ¨me constatÃ©

MalgrÃ© Ã§a, tu pouvais quand mÃªme publier une 6áµ‰ annonce.

On a dÃ©couvert que :

Le backend vÃ©rifie bien, mais il faut Ãªtre sÃ»r que userId arrive dans vehicleData.

Le frontend (CreateListingForm.tsx) utilise une fonction canProceed() qui ne connaÃ®t que la validation du formulaire (titre, description, etc.), mais pas le quota.

3. Diagnostic via logs

Tu as ajoutÃ© un console.log("DEBUG USER ID:", vehicleData.userId); â†’ pour voir si le backend reÃ§oit bien lâ€™utilisateur.

Les logs frontend montrent que canProceed = false tant que les champs sont vides, mais pas liÃ© au quota.

Donc : cÃ´tÃ© backend, il faut bien bloquer si canCreate = false.

CÃ´tÃ© frontend, il faut enrichir canProceed avec une vÃ©rification du quota pour dÃ©sactiver le bouton et afficher un message clair.

4. Prochaines actions

CÃ´tÃ© serveur :

VÃ©rifier que return res.status(403)... empÃªche bien storage.createVehicle de sâ€™exÃ©cuter.

VÃ©rifier que userId est toujours envoyÃ© par le front.

CÃ´tÃ© client :

Appeler /api/users/:id/quota au chargement du formulaire.

Stocker quota.remaining.

DÃ©sactiver le bouton si remaining = 0.

Afficher un message â€œVous avez atteint votre limite dâ€™annoncesâ€.

ğŸ‘‰ En rÃ©sumÃ© :

Backend : la logique est dÃ©jÃ  prÃªte â†’ juste sâ€™assurer que userId est bien transmis et que le return stoppe vraiment la crÃ©ation.

Frontend : il manque la prise en compte du quota (câ€™est pour Ã§a que le bouton reste cliquable et quâ€™un particulier peut quand mÃªme essayer de soumettre).